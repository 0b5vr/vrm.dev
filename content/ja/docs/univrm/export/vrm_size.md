---
title: "VRMモデルのファイルサイズ"
date: 2020-08-13
weight: 3
tags: []
aliases: []
---

VRMは、GLBの拡張なので、

`VRMエクスポートしたファイルのサイズ = glb`

`glb = json + binary`

です。
`json` はテキストなので通常は 1MB にもなりません。

`binary` で主なものは、

`texture(image)` と `mesh` です。

5万頂点、5万三角形のモデルを例とします。

## Image

Material が参照する Texture の PNG のバイト列がそのまま入っています。
Meta の Thumbnail も対象になります。

> v0.56 でローカルに元ファイルがあった場合にそのまま使うようにした結果、
元ファイルが巨大であった場合に、以前に比べて大きくなる問題が発生しています。v0.58 修正予定。

https://github.com/vrm-c/UniVRM/issues/502

## Mesh

Index バッファ と 頂点バッファです。

### Indexバッファ

Indexバッファは、Intの配列を使っています。

`50000 x 4 x 3 => 0.6MB` の容量を使います。

> GLTFの仕様的には、 unsigned short も可能

### 頂点バッファ

一頂点は、

```
{
    float3 Position; // 頂点位置 4 x 3 => 12byte
    float3 Normal; // 頂点法線 4 x 3 => 12byte
    float2 TEXCOORD_0; // 頂点UV 4 x 2 => 8byte
    short4 JOINTS_0; // 頂点BoneIndex(4 weight skinning) 2 x 4 => 8byte
    float4 WEIGHTS_0; // 頂点Weight(4 weight skinning) 4 x 4 => 16byte
}
```

となっています(頂点カラーのあるモデルなどバリエーションがありうる)。

`50000 x (12 + 12 + 8 + 8 + 16) => 2.8MB` の容量を使います。

## 基本容量

以上、 `画像サイズ合計 + インデックスバッファ + 頂点バッファ` の合計がモデルの基本容量になります。
どのモデルでも、予測通りの範囲に収まります。
以降、時として容量爆発の原因となるブレンドシェイプの容量についてです。

## ブレンドシェイプ(MorphTarget)の容量

```ブレンドシェイプ頂点
{
    float3 Position; // 頂点位置 4 x 3 => 12byte. 必須
    float3 Normal; // 頂点法線 4 x 3 => 12byte. UniVRM-0.56 からエクスポートオプションで省略可能になった
    float3 Tangent; // 頂点Tangent 4 x 3 => 12byte. 記録しない
}
```

ひとつのブレンドシェイプで `50000 x (12 + 12) => 1.2MB` の容量を使います。

20のブレンドシェイプがあったとすると,
`50000 x (12 + 12) x 20 => 24MB` の容量を使います。

60のブレンドシェイプがあると、
`50000 x (12 + 12) x 60 => 72MB` の容量を使います。

モデルの構成によっては、予想外にファイルサイズが爆発する場合があります。

### ブレンドシェイプの容量対策

#### MeshUtility で分割する

例えば、顔が 10000 頂点、体が 40000 頂点に分割されていると、

ひとつのブレンドシェイプで `10000 x (12 + 12) => 0.24MB` の容量を使います。

容量削減が可能です。

> ランタイムにも良い可能性があるが、ドローコールは増えるかもしれないのでトレードオフ

TODO: MeshUtility の使い方

#### Sparse 機能を有効にする


#### 不要な BlendShape を削減する

